# ==============================================================================
# Nimbus 函数计算平台配置文件
# ==============================================================================
# 此配置文件定义了函数计算平台的所有核心配置参数
# 包括服务器设置、运行时配置、存储连接等

# ------------------------------------------------------------------------------
# 服务器配置
# ------------------------------------------------------------------------------
server:
  http_port: 8080           # HTTP API 服务端口，用于接收函数管理和调用请求
  invoke_port: 8081         # 函数调用专用端口（可选，用于分离管理和调用流量）
  metrics_port: 9090        # Prometheus 指标暴露端口
  shutdown_timeout: 30s     # 优雅关闭超时时间，等待现有请求完成

# ------------------------------------------------------------------------------
# 运行时模式配置
# ------------------------------------------------------------------------------
runtime:
  mode: firecracker         # 运行时模式: firecracker（生产环境）或 docker（开发环境）

# ------------------------------------------------------------------------------
# Firecracker 虚拟机配置
# ------------------------------------------------------------------------------
# Firecracker 是 AWS 开源的轻量级虚拟机管理器
# 提供毫秒级启动时间和强隔离性
firecracker:
  binary: /opt/firecracker/bin/firecracker   # Firecracker 二进制文件路径
  kernel: /opt/firecracker/kernel/vmlinux    # Linux 内核镜像路径
  rootfs_dir: /opt/firecracker/rootfs        # 根文件系统存储目录
  socket_dir: /opt/firecracker/sockets       # Unix socket 文件目录
  vsock_dir: /opt/firecracker/vsock          # vsock 通信目录
  snapshot_dir: /opt/firecracker/snapshots   # 快照存储目录（用于快速启动）
  log_dir: /opt/firecracker/logs             # 虚拟机日志目录
  boot_timeout: 10s                          # 虚拟机启动超时时间

# ------------------------------------------------------------------------------
# 网络配置
# ------------------------------------------------------------------------------
# 配置虚拟机的网络连接，使用网桥和 NAT 实现网络隔离
network:
  bridge_name: fcbr0           # 网桥名称
  bridge_ip: 172.20.0.1        # 网桥 IP 地址（作为虚拟机的网关）
  subnet_cidr: 172.20.0.0/16   # 虚拟机使用的子网 CIDR
  cni_config_dir: /etc/cni/net.d  # CNI 配置文件目录
  cni_bin_dir: /opt/cni/bin    # CNI 插件二进制文件目录
  use_nat: true                # 是否启用 NAT（允许虚拟机访问外部网络）
  external_interface: eth0     # 外部网络接口名称

# ------------------------------------------------------------------------------
# 虚拟机池配置
# ------------------------------------------------------------------------------
# 虚拟机池通过预热虚拟机来降低函数冷启动延迟
pool:
  health_check_interval: 10s   # 健康检查间隔
  scale_check_interval: 30s    # 自动扩缩容检查间隔
  max_vm_age: 1h               # 虚拟机最大存活时间（超时后回收）
  max_invocations: 1000        # 单个虚拟机最大调用次数（超过后回收）
  use_snapshots: true          # 是否使用快照加速启动
  snapshot_warmup: 5           # 快照预热数量

  # 各运行时的池配置
  runtimes:
    # Python 3.11 运行时配置
    - runtime: python3.11
      min_warm: 2              # 最小预热虚拟机数量
      max_total: 50            # 最大虚拟机总数
      target_warm: 5           # 目标预热虚拟机数量
      scale_up_factor: 0.8     # 扩容因子（使用率超过此值时扩容）
      scale_down_factor: 0.3   # 缩容因子（使用率低于此值时缩容）
      memory_mb: 256           # 虚拟机内存大小（MB）
      vcpus: 1                 # 虚拟 CPU 数量

    # Node.js 20 运行时配置
    - runtime: nodejs20
      min_warm: 2
      max_total: 50
      target_warm: 5
      scale_up_factor: 0.8
      scale_down_factor: 0.3
      memory_mb: 256
      vcpus: 1

    # Go 1.24 运行时配置
    - runtime: go1.24
      min_warm: 1
      max_total: 30
      target_warm: 3
      scale_up_factor: 0.8
      scale_down_factor: 0.3
      memory_mb: 128           # Go 程序通常内存占用较小
      vcpus: 1

    # WebAssembly 运行时配置
    - runtime: wasm
      min_warm: 2
      max_total: 100           # WASM 虚拟机轻量，可以运行更多实例
      target_warm: 10
      scale_up_factor: 0.8
      scale_down_factor: 0.3
      memory_mb: 64            # WASM 运行时内存占用极小
      vcpus: 1

# ------------------------------------------------------------------------------
# 调度器配置
# ------------------------------------------------------------------------------
scheduler:
  workers: 10                  # 并发工作协程数量
  queue_size: 1000             # 任务队列大小
  default_timeout: 30s         # 默认函数执行超时时间
  max_retries: 3               # 最大重试次数

# ------------------------------------------------------------------------------
# 存储配置
# ------------------------------------------------------------------------------
storage:
  # PostgreSQL 数据库配置
  # 用于存储函数定义、调用记录等持久化数据
  postgres:
    host: localhost
    port: 5432
    database: nimbus
    user: nimbus
    password: nimbus
    max_connections: 25        # 最大连接数

  # Redis 配置
  # 用于缓存、任务队列和分布式锁
  redis:
    address: localhost:6379
    db: 0                      # 使用的数据库编号

# ------------------------------------------------------------------------------
# 事件系统配置
# ------------------------------------------------------------------------------
events:
  nats_url: nats://localhost:4222  # NATS 消息队列服务器地址

# ------------------------------------------------------------------------------
# 日志配置
# ------------------------------------------------------------------------------
logging:
  level: info                  # 日志级别: debug, info, warn, error
  format: json                 # 日志格式: json 或 text

# ------------------------------------------------------------------------------
# 指标配置
# ------------------------------------------------------------------------------
metrics:
  enabled: true                # 是否启用 Prometheus 指标
  namespace: nimbus            # 指标命名空间前缀
